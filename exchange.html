<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>汇率表</title>
	  <link
      rel="icon"
      href="https://raw.githubusercontent.com/mubai16888/mb/main/mb.ico"
      type="image/x-icon"
    />
    <link
      rel="icon"
      href="https://raw.githubusercontent.com/mubai16888/mb/main/mb.png"
      type="image/png"
      sizes="192x192"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f6fa;
        display: flex;
        justify-content: center;
        padding: 40px 0;
      }
      .table-container {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        display: inline-block;
        position: relative;
        height: auto;
        max-height: 80vh;
        overflow: auto;
        scrollbar-width: none;
      }
      .table-container::-webkit-scrollbar {
        display: none;
      }
      table {
        border-collapse: separate;
        border-spacing: 0;
        table-layout: auto;
        text-align: center;
        font-size: 16px;
        font-weight: 450;
        width: 100%;
      }
      thead tr {
        background: linear-gradient(135deg, #1e90ff, #00cfff);
        border-radius: 8px;
        display: table;
        width: 100%;
        box-sizing: border-box;
      }
      thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        color: #fff;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        border: none;
        padding: 10px 12px;
      }
      th,
      td {
        padding: 10px 12px;
        vertical-align: middle;
        position: relative;
        transition: all 0.25s ease;
      }
      th.sortable {
        cursor: pointer;
        position: relative;
        user-select: none;
      }
      th.sortable::after {
        content: "↕";
        font-size: 12px;
        margin-left: 5px;
        color: #fff;
        opacity: 0.8;
        transition: all 0.3s ease;
      }
      th.sortable.asc::after {
        content: "⬆️";
        opacity: 1;
      }
      th.sortable.desc::after {
        content: "⬇️";
        opacity: 1;
      }
      tbody tr {
        position: relative;
        border-radius: 8px;
        margin: 6px 0;
        display: table;
        width: 100%;
        box-sizing: border-box;
        transition: transform 0.25s ease, box-shadow 0.25s ease,
          filter 0.25s ease;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        background: transparent;
      }
      tbody tr::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        transition: all 0.25s ease;
        border-radius: 8px;
        pointer-events: none;
        background: var(--gradient-bg, transparent);
      }
      tbody tr:hover {
        transform: scale(1.03);
        cursor: pointer;
      }
      tbody tr td {
        position: relative;
        z-index: 1;
      }
      td.editable {
        cursor: default;
      }
      td.editable.editing {
        cursor: text !important;
      }
      td input[type="text"] {
        width: 100px;
        padding: 4px 6px;
        font-size: 14px;
        border: 1px solid #1e90ff;
        border-radius: 6px;
        outline: none;
        box-sizing: border-box;
      }

      /* 汇率列数字对齐*/
      #rateTable td:nth-child(2),
      #rateTable th:nth-child(2) {
        text-align: right;
        padding-right: 20px;
        font-variant-numeric: tabular-nums; /* 等宽数字 */
      }

      .add-row-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
        color: #fff;
        transition: transform 0.25s ease, color 0.25s ease;
      }
      .add-row-btn:hover {
        transform: scale(1.3);
        color: #d0e6ff;
      }
      #contextMenu {
        position: absolute;
        display: none;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        min-width: 140px;
        overflow: hidden;
      }
      #contextMenu button {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 8px 12px;
        border: none;
        background: none;
        text-align: left;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s, color 0.2s;
      }
      #contextMenu button i {
        margin-right: 8px;
      }
      #contextMenu button:hover {
        background: #f0f6ff;
        color: #1e90ff;
      }
      #colorPalette {
        position: fixed;
        display: none;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 10px;
        padding: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1100;
        grid-template-columns: repeat(6, 20px);
        gap: 6px;
      }
      .color-swatch {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        cursor: pointer;
        border: 1px solid #ddd;
        transition: transform 0.2s, border-color 0.2s;
      }
      .color-swatch:hover {
        transform: scale(1.25);
        border-color: #1e90ff;
      }
      .color-more {
        grid-column: span 6;
        text-align: center;
        font-size: 12px;
        padding: 4px;
        cursor: pointer;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #f9f9f9;
        transition: background 0.2s;
      }
      .color-more:hover {
        background: #f0f0f0;
        color: #1e90ff;
      }
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1200;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .modal.show {
        opacity: 1;
      }
      .modal-content {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        width: 280px;
        text-align: center;
        transform: translateY(-20px);
        opacity: 0;
        transition: all 0.3s ease;
      }
      .modal.show .modal-content {
        transform: translateY(0);
        opacity: 1;
      }
      .modal-content h3 {
        margin-bottom: 12px;
        font-size: 16px;
        color: #333;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      .modal-content h3 i {
        color: #1e90ff;
      }
      .modal-content input,
      .modal-content textarea {
        width: 90%;
        padding: 6px 8px;
        margin: 6px 0;
        border: 1px solid #ccc;
        border-radius: 6px;
        outline: none;
        font-size: 14px;
        box-sizing: border-box;
        transition: all 0.3s ease;
      }
      .modal-content input:focus,
      .modal-content textarea:focus {
        border-color: #1e90ff;
        box-shadow: 0 0 0 2px rgba(30, 144, 255, 0.2);
      }
      .modal-content textarea {
        resize: none;
        height: 80px;
      }
      .modal-buttons {
        margin-top: 12px;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }
      .modal-buttons button {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .btn-primary {
        background: #1e90ff;
        color: #fff;
      }
      .btn-primary:hover {
        background: #0c7cd5;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .btn-cancel {
        background: #f0f0f0;
      }
      .btn-cancel:hover {
        background: #e0e0e0;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .btn-delete {
        background: #ff4d4f;
        color: #fff;
      }
      .btn-delete:hover {
        background: #e04344;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      #remarkTooltip {
        position: fixed;
        pointer-events: none;
        background: linear-gradient(135deg, #1890ff, #096dd9);
        color: #fff;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.2s;
        max-width: 300px;
        white-space: normal;
        word-wrap: break-word;
      }

      /* 让汇率列数字对齐*/
      #rateTable td:nth-child(2),
      #rateTable th:nth-child(2) {
        text-align: right;
        padding-right: 20px;
        font-variant-numeric: tabular-nums; /* 等宽数字，保证对齐更漂亮 */
      }

      /* 美化输入框容器 */
      .input-group {
        position: relative;
        margin: 10px 0;
        display: flex;
        align-items: center;
      }
      .input-group i {
        position: absolute;
        left: 10px;
        color: #1e90ff;
        z-index: 1;
      }
      .input-group input {
        width: 100%;
        padding-left: 32px;
      }
      .input-group textarea {
        width: 100%;
        padding-left: 32px;
      }
    </style>
  </head>
  <body>
    <div class="table-container">
      <table id="rateTable">
        <thead>
          <tr>
            <th>
              三方代收
              <button class="add-row-btn" onclick="addRowModal()" title="新增">
                <i class="fas fa-plus"></i>
              </button>
            </th>
            <th class="sortable" onclick="sortTable()">汇率</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="contextMenu">
        <button onclick="contextChangeColor()">
          <i class="fas fa-palette"></i> 赋色
        </button>
        <button onclick="contextRemark()">
          <i class="fas fa-sticky-note"></i> 备注
        </button>
        <button onclick="contextDeleteRow()">
          <i class="fas fa-trash"></i> 删除行
        </button>
      </div>

      <div id="colorPalette"></div>

      <div id="addModal" class="modal">
        <div class="modal-content">
          <h3><i class="fas fa-plus-circle"></i> 新增币种</h3>
          <div class="input-group">
            <i class="fas fa-font"></i>
            <input type="text" id="currencyName" placeholder="请输入名称" />
          </div>
          <div class="input-group">
            <i class="fas fa-exchange-alt"></i>
            <input type="text" id="currencyRate" placeholder="请输入汇率" />
          </div>
          <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeAddModal()">
              <i class="fas fa-times"></i> 取消
            </button>
            <button class="btn-primary" onclick="confirmAdd()">
              <i class="fas fa-check"></i> 确定
            </button>
          </div>
        </div>
      </div>

      <div id="deleteModal" class="modal">
        <div class="modal-content">
          <h3><i class="fas fa-exclamation-triangle"></i> 确认删除该行？</h3>
          <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeDeleteModal()">
              <i class="fas fa-times"></i> 取消
            </button>
            <button class="btn-primary" onclick="confirmDelete()">
              <i class="fas fa-trash"></i> 删除
            </button>
          </div>
        </div>
      </div>

      <div id="remarkModal" class="modal">
        <div class="modal-content">
          <h3><i class="fas fa-sticky-note"></i> 备注</h3>
          <div class="input-group">
            <i class="fas fa-comment-alt"></i>
            <textarea id="remarkInput" placeholder="请输入备注内容"></textarea>
          </div>
          <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeRemarkModal()">
              <i class="fas fa-times"></i> 取消
            </button>
            <button class="btn-primary" onclick="confirmRemark()">
              <i class="fas fa-save"></i> 保存
            </button>
            <button class="btn-delete" onclick="deleteRemark()">
              <i class="fas fa-trash"></i> 删除
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="remarkTooltip"></div>

    <script>
      let selectedRow = null;
      let lastColor = "#ffffff";
      let recentColors = [];
      let sortAsc = true; // 初始为升序

      const tableContainer = document.querySelector(".table-container");
      const contextMenu = document.getElementById("contextMenu");
      const colorPalette = document.getElementById("colorPalette");
      const remarkTooltip = document.getElementById("remarkTooltip");

      // ------------------ 数据存储 ------------------
      function saveData() {
        const tbody = document.getElementById("rateTable").tBodies[0];
        const rows = Array.from(tbody.rows);
        const data = rows.map((row) => ({
          name: row.cells[0].innerText.trim(),
          rate: row.cells[1].innerText.trim(),
          color: row.style.getPropertyValue("--gradient-bg") || "",
          remark: row.getAttribute("data-remark") || "",
        }));
        localStorage.setItem("rateTableData", JSON.stringify(data));
        localStorage.setItem("recentColors", JSON.stringify(recentColors));
      }

      function loadData() {
        const tbody = document.getElementById("rateTable").tBodies[0];
        tbody.innerHTML = "";
        const data = JSON.parse(localStorage.getItem("rateTableData") || "[]");
        recentColors = JSON.parse(localStorage.getItem("recentColors") || "[]");
        if (data.length === 0) {
          addRow("美元", "7.00");
          addRow("欧元", "7.50");
        } else {
          data.forEach((item) => {
            const row = document.createElement("tr");
            if (item.color) row.style.setProperty("--gradient-bg", item.color);
            if (item.remark) row.setAttribute("data-remark", item.remark);
            row.innerHTML = `<td class="editable" ondblclick="editCell(this)">${item.name}</td><td class="editable" ondblclick="editCell(this)">${item.rate}</td>`;
            tbody.appendChild(row);
          });
        }
        buildColorPalette();
        updateSortIcon(); // 初始化排序图标
      }

      // ------------------ 编辑单元格 ------------------
      function editCell(td) {
        const oldValue = td.innerText.trim();
        const input = document.createElement("input");
        input.type = "text";
        input.value = oldValue;
        td.innerHTML = "";
        td.appendChild(input);
        input.focus();
        input.addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            if (td.cellIndex === 1) {
              if (!isNaN(input.value) && input.value.trim() !== "")
                td.innerText = parseFloat(input.value).toFixed(2);
              else td.innerText = oldValue;
            } else td.innerText = input.value;
            saveData();
          } else if (e.key === "Escape") {
            td.innerText = oldValue;
          }
        });
        input.addEventListener("blur", function () {
          if (td.cellIndex === 1) {
            if (!isNaN(input.value) && input.value.trim() !== "")
              td.innerText = parseFloat(input.value).toFixed(2);
            else td.innerText = oldValue;
          } else td.innerText = input.value;
          saveData();
        });
      }

      // ------------------ 新增行 ------------------
      function addRowModal() {
        document.getElementById("currencyName").value = "";
        document.getElementById("currencyRate").value = "";
        const modal = document.getElementById("addModal");
        modal.style.display = "flex";
        setTimeout(() => {
          modal.classList.add("show");
          document.getElementById("currencyName").focus();
        }, 10);
      }

      function closeAddModal() {
        const modal = document.getElementById("addModal");
        modal.classList.remove("show");
        setTimeout(() => {
          modal.style.display = "none";
        }, 300);
      }

      function confirmAdd() {
        const name = document.getElementById("currencyName").value.trim();
        const rate = document.getElementById("currencyRate").value.trim();
        if (!name) {
          alert("请输入名称");
          return;
        }
        if (isNaN(rate) || rate === "") {
          alert("请输入有效汇率");
          return;
        }
        addRow(name, parseFloat(rate).toFixed(2));
        closeAddModal();
      }

      function addRow(name = "新币种", rate = "0.00") {
        const tbody = document.getElementById("rateTable").tBodies[0];
        const row = document.createElement("tr");
        row.innerHTML = `<td class="editable" ondblclick="editCell(this)">${name}</td><td class="editable" ondblclick="editCell(this)">${rate}</td>`;
        tbody.appendChild(row);
        saveData();
      }

      // ------------------ 排序 ------------------
      function sortTable() {
        const tbody = document.getElementById("rateTable").tBodies[0];
        const rows = Array.from(tbody.rows);
        rows.sort((a, b) => {
          const valA = parseFloat(a.cells[1].innerText.trim());
          const valB = parseFloat(b.cells[1].innerText.trim());
          return sortAsc ? valA - valB : valB - valA;
        });
        rows.forEach((row) => tbody.appendChild(row));
        sortAsc = !sortAsc;
        updateSortIcon(); // 更新排序图标
        saveData();
      }

      // ------------------ 更新排序图标 ------------------
      function updateSortIcon() {
        const sortableTh = document.querySelector("th.sortable");
        sortableTh.classList.remove("asc", "desc");
        if (sortAsc) {
          sortableTh.classList.add("asc");
        } else {
          sortableTh.classList.add("desc");
        }
      }

      // ------------------ 右键菜单 ------------------
      document
        .getElementById("rateTable")
        .addEventListener("contextmenu", function (e) {
          e.preventDefault();
          const tr = e.target.closest("tr");
          if (tr) {
            selectedRow = tr;
            contextMenu.style.visibility = "hidden";
            contextMenu.style.display = "block";
            const menuRect = contextMenu.getBoundingClientRect();
            const rect = tableContainer.getBoundingClientRect();
            let offsetX = e.clientX - rect.left;
            let offsetY = e.clientY - rect.top;
            const containerWidth = tableContainer.clientWidth;
            const containerHeight = tableContainer.clientHeight;
            if (offsetX + menuRect.width > containerWidth)
              offsetX = containerWidth - menuRect.width;
            if (offsetY + menuRect.height > containerHeight)
              offsetY = containerHeight - menuRect.height;
            if (offsetX < 0) offsetX = 0;
            if (offsetY < 0) offsetY = 0;
            contextMenu.style.left = offsetX + "px";
            contextMenu.style.top = offsetY + "px";
            contextMenu.style.visibility = "visible";
          } else contextMenu.style.display = "none";
        });
      document.addEventListener("click", function (e) {
        if (!contextMenu.contains(e.target)) contextMenu.style.display = "none";
      });

      // ------------------ 删除行 ------------------
      let rowToDelete = null;
      function contextDeleteRow() {
        rowToDelete = selectedRow;
        const modal = document.getElementById("deleteModal");
        modal.style.display = "flex";
        setTimeout(() => {
          modal.classList.add("show");
        }, 10);
      }

      function closeDeleteModal() {
        const modal = document.getElementById("deleteModal");
        modal.classList.remove("show");
        setTimeout(() => {
          modal.style.display = "none";
        }, 300);
      }

      function confirmDelete() {
        if (rowToDelete) rowToDelete.remove();
        rowToDelete = null;
        saveData();
        closeDeleteModal();
      }

      // ------------------ 备注 ------------------
      function contextRemark() {
        const remark = selectedRow.getAttribute("data-remark") || "";
        document.getElementById("remarkInput").value = remark;
        const modal = document.getElementById("remarkModal");
        modal.style.display = "flex";
        setTimeout(() => {
          modal.classList.add("show");
          document.getElementById("remarkInput").focus();
        }, 10);
      }

      function closeRemarkModal() {
        const modal = document.getElementById("remarkModal");
        modal.classList.remove("show");
        setTimeout(() => {
          modal.style.display = "none";
        }, 300);
      }

      function confirmRemark() {
        selectedRow.setAttribute(
          "data-remark",
          document.getElementById("remarkInput").value
        );
        saveData();
        closeRemarkModal();
      }

      function deleteRemark() {
        selectedRow.removeAttribute("data-remark");
        saveData();
        closeRemarkModal();
      }

      // ------------------ 鼠标悬停显示备注 ------------------
      tableContainer.addEventListener("mousemove", function (e) {
        const tr = e.target.closest("tr");
        if (!tr || !tr.getAttribute("data-remark")) {
          remarkTooltip.style.opacity = 0;
          return;
        }
        remarkTooltip.innerText = tr.getAttribute("data-remark");
        let x = e.clientX + 15;
        let y = e.clientY + 15;
        if (x + remarkTooltip.offsetWidth > window.innerWidth)
          x = e.clientX - remarkTooltip.offsetWidth - 15;
        if (y + remarkTooltip.offsetHeight > window.innerHeight)
          y = e.clientY - remarkTooltip.offsetHeight - 15;
        remarkTooltip.style.left = x + "px";
        remarkTooltip.style.top = y + "px";
        remarkTooltip.style.opacity = 1;
      });
      tableContainer.addEventListener("mouseleave", function () {
        remarkTooltip.style.opacity = 0;
      });

      // ------------------ 赋色功能 ------------------
      const presetColors = [
        "#ffffff",
        "#f28b82",
        "#fbbc04",
        "#fff475",
        "#ccff90",
        "#a7ffeb",
        "#cbf0f8",
        "#aecbfa",
        "#d7aefb",
        "#e6c9a8",
        "#e8eaed",
        "#000000",
      ];

      function addRecentColor(color) {
        recentColors = [color, ...recentColors.filter((c) => c !== color)];
        if (recentColors.length > 5) recentColors = recentColors.slice(0, 5);
        saveData();
      }

      function lightenColor(color, percent) {
        const num = parseInt(color.replace("#", ""), 16),
          amt = Math.round(2.55 * percent),
          R = (num >> 16) + amt,
          G = ((num >> 8) & 0x00ff) + amt,
          B = (num & 0x0000ff) + amt;
        return (
          "#" +
          (
            0x1000000 +
            (R < 255 ? (R < 1 ? 0 : R) : 255) * 0x10000 +
            (G < 255 ? (G < 1 ? 0 : G) : 255) * 0x100 +
            (B < 255 ? (B < 1 ? 0 : B) : 255)
          )
            .toString(16)
            .slice(1)
        );
      }

      function buildColorPalette() {
        colorPalette.innerHTML = "";
        if (recentColors.length > 0) {
          const recentLabel = document.createElement("div");
          recentLabel.style.gridColumn = "span 6";
          recentLabel.style.fontSize = "12px";
          recentLabel.style.marginBottom = "4px";
          recentLabel.style.color = "#555";
          recentLabel.innerText = "最近使用";
          colorPalette.appendChild(recentLabel);
          recentColors.forEach((c) => {
            const swatch = document.createElement("div");
            swatch.className = "color-swatch";
            swatch.style.backgroundColor = c;
            swatch.addEventListener("click", () => applyColor(c));
            colorPalette.appendChild(swatch);
          });
          if (recentColors.length < 6)
            for (let i = 0; i < 6 - recentColors.length; i++)
              colorPalette.appendChild(document.createElement("div"));
        }
        presetColors.forEach((c) => {
          const swatch = document.createElement("div");
          swatch.className = "color-swatch";
          swatch.style.backgroundColor = c;
          swatch.addEventListener("click", () => applyColor(c));
          colorPalette.appendChild(swatch);
        });
        const more = document.createElement("div");
        more.className = "color-more";
        more.innerText = "更多颜色...";
        more.addEventListener("click", () => {
          const colorInput = document.createElement("input");
          colorInput.type = "color";
          colorInput.value = lastColor;
          colorInput.style.display = "none";
          document.body.appendChild(colorInput);
          colorInput.click();
          colorInput.addEventListener("input", function () {
            if (selectedRow) {
              const light = lightenColor(colorInput.value, 50);
              selectedRow.style.setProperty(
                "--gradient-bg",
                `linear-gradient(to bottom, ${light}, ${colorInput.value})`
              );
              lastColor = colorInput.value;
            }
          });
          colorInput.addEventListener("change", function () {
            if (selectedRow) addRecentColor(colorInput.value);
            buildColorPalette();
            document.body.removeChild(colorInput);
            colorPalette.style.display = "none";
          });
        });
        colorPalette.appendChild(more);
      }

      function applyColor(color) {
        if (!selectedRow) return;
        const light = lightenColor(color, 50);
        selectedRow.style.setProperty(
          "--gradient-bg",
          `linear-gradient(to bottom, ${light}, ${color})`
        );
        lastColor = color;
        addRecentColor(color);
        buildColorPalette();
        colorPalette.style.display = "none";
      }

      function contextChangeColor() {
        if (!selectedRow) return;
        // 隐藏右键菜单
        contextMenu.style.display = "none";

        buildColorPalette();
        const rowRect = selectedRow.getBoundingClientRect();
        const paletteRect = colorPalette.getBoundingClientRect();
        let top = rowRect.bottom + 4;
        let left = rowRect.left;
        if (top + paletteRect.height > window.innerHeight)
          top = rowRect.top - paletteRect.height - 4;
        if (left + paletteRect.width > window.innerWidth)
          left = window.innerWidth - paletteRect.width - 4;
        if (top < 4) top = 4;
        if (left < 4) left = 4;
        colorPalette.style.top = top + "px";
        colorPalette.style.left = left + "px";
        colorPalette.style.display = "grid";
      }

      tableContainer.addEventListener("scroll", () => {
        if (!selectedRow || colorPalette.style.display !== "grid") return;
        contextChangeColor();
      });

      document.addEventListener("click", function (e) {
        if (!colorPalette.contains(e.target) && !contextMenu.contains(e.target))
          colorPalette.style.display = "none";
      });

      // ------------------ 回车键功能 ------------------
      document.addEventListener("keydown", function (e) {
        // 新增币种模态框的回车确认
        if (
          e.key === "Enter" &&
          document.getElementById("addModal").style.display === "flex"
        ) {
          confirmAdd();
        }

        // 备注模态框的回车确认
        if (
          e.key === "Enter" &&
          document.getElementById("remarkModal").style.display === "flex"
        ) {
          if (e.ctrlKey) {
            // Ctrl+Enter 换行
            return;
          } else {
            e.preventDefault();
            confirmRemark();
          }
        }
      });

      // ------------------ 初始化 ------------------
      loadData();
    </script>
  </body>
</html>
